<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Focus Detector</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #f0f0f0;
    }
    .container {
      position: relative;
      display: inline-block;
    }
    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
      font-weight: bold;
    }
    .status.focused {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.unfocused {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.no-face {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
  </style>
</head>
<body>
  <div class="container">
    <video id="video" width="640" height="480" autoplay muted></video>
    <canvas id="overlay" width="640" height="480" style="position:absolute; top:0; left:0;"></canvas>
  </div>
  <div id="status" class="status">æ­£åœ¨åŠ è½½...</div>
  
  <script src="https://unpkg.com/face-api.js/dist/face-api.min.js"></script>
  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const statusDiv = document.getElementById('status');
    const ctx = overlay.getContext('2d');

    let lastAlertTime = 0;
    const ALERT_COOLDOWN = 3000; // 3ç§’å†…ä¸é‡å¤æé†’
    let lastFaceTime = Date.now();
    const ABSENCE_THRESHOLD = 5000; // 5ç§’
    const ABSENCE_ALERT = 5 * 60 * 1000; // 5åˆ†é’Ÿ
    let absenceAlerted = false;

    async function setup() {
      await faceapi.nets.tinyFaceDetector.loadFromUri('/weights');
      await faceapi.nets.faceLandmark68TinyNet.loadFromUri('/weights');
      startVideo();
    }

    function startVideo() {
      navigator.mediaDevices.getUserMedia({ video: {} })
        .then(stream => video.srcObject = stream)
        .catch(err => console.error(err));
    }

    function updateStatus(message, className) {
      statusDiv.textContent = message;
      statusDiv.className = `status ${className}`;
    }

    function showAlert(message) {
      const now = Date.now();
      if (now - lastAlertTime > ALERT_COOLDOWN) {
        alert(message);
        lastAlertTime = now;
      }
    }

    video.addEventListener('play', () => {
      const centerX = overlay.width / 2;
      const centerY = overlay.height / 2;
      const options = new faceapi.TinyFaceDetectorOptions({
        inputSize: 416,
        scoreThreshold: 0.3
      });
      // ç»˜åˆ¶ä¸­å¿ƒå‚è€ƒçº¿
      function drawCenterLines() {
        ctx.strokeStyle = 'rgba(0, 255, 0, 0.5)';
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]);
        
        // å‚ç›´çº¿
        ctx.beginPath();
        ctx.moveTo(centerX, 0);
        ctx.lineTo(centerX, overlay.height);
        ctx.stroke();
        
        // æ°´å¹³çº¿
        ctx.beginPath();
        ctx.moveTo(0, centerY);
        ctx.lineTo(overlay.width, centerY);
        ctx.stroke();
        
        ctx.setLineDash([]);
      }

      setInterval(async () => {
        const detection = await faceapi
          .detectSingleFace(video, options)
          .withFaceLandmarks(true);

        ctx.clearRect(0, 0, overlay.width, overlay.height);
        drawCenterLines();

        if (detection) {
          const nose = detection.landmarks.getNose()[0];
          const leftEye = detection.landmarks.getLeftEye()[0];
          const rightEye = detection.landmarks.getRightEye()[0];

          // ç»˜åˆ¶æ£€æµ‹æ¡†å’Œå…³é”®ç‚¹
          ctx.strokeStyle = 'green';
          ctx.lineWidth = 3;
          ctx.strokeRect(detection.detection.box.x, detection.detection.box.y, 
                        detection.detection.box.width, detection.detection.box.height);

          // ç»˜åˆ¶é¼»å­ç‚¹
          ctx.fillStyle = 'yellow';
          ctx.beginPath();
          ctx.arc(nose.x, nose.y, 5, 0, Math.PI * 2);
          ctx.fill();

          // ç»˜åˆ¶çœ¼ç›ç‚¹
          ctx.fillStyle = 'blue';
          ctx.beginPath();
          ctx.arc(leftEye.x, leftEye.y, 3, 0, Math.PI * 2);
          ctx.fill();
          ctx.beginPath();
          ctx.arc(rightEye.x, rightEye.y, 3, 0, Math.PI * 2);
          ctx.fill();

          // åªè¦æ£€æµ‹åˆ°äººè„¸å°±æ›´æ–°æ—¶é—´ï¼Œå¹¶é‡ç½®å¼¹çª—æ ‡å¿—
          lastFaceTime = Date.now();
          absenceAlerted = false;
        }

        // çŠ¶æ€æ˜¾ç¤ºé€»è¾‘ï¼š5ç§’å†…æ£€æµ‹åˆ°è¿‡äººè„¸å°±æ˜¾ç¤ºæ­£å¯¹å±å¹•
        if (Date.now() - lastFaceTime <= ABSENCE_THRESHOLD) {
          updateStatus('ğŸŸ¢ æ­£å¯¹å±å¹•', 'focused');
        } else {
          updateStatus('âš ï¸ æœªæ£€æµ‹åˆ°äººè„¸', 'no-face');
        }

        // 5åˆ†é’Ÿæœªæ£€æµ‹åˆ°äººè„¸ï¼Œå¼¹çª—ä¸€æ¬¡
        if (!absenceAlerted && Date.now() - lastFaceTime > ABSENCE_ALERT) {
          alert('è¶…è¿‡5åˆ†é’Ÿæœªæ£€æµ‹åˆ°äººè„¸ï¼Œè¯·å›åˆ°å±å¹•å‰ï¼');
          absenceAlerted = true;
        }
      }, 1000); // æ¯1ç§’æ£€æµ‹ä¸€æ¬¡
    });

    setup();
  </script>
</body>
</html>
